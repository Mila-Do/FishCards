---
import Layout from "../../layouts/Layout.astro";
import { ForgotPasswordForm, PasswordResetForm } from "../../components/auth/ForgotPasswordForm";

// TODO: In backend implementation, add server-side logic to:
// 1. Check if user is already authenticated (redirect to /dashboard if logged in)
// 2. Validate reset token if provided in URL
// 3. Handle token expiration
// 4. Add rate limiting for password reset requests
// 5. Set appropriate meta tags

const title = "Resetuj hasło | FishCards";
const token = Astro.url.searchParams.get("token");
const isResetFlow = !!token;

// Server-side auth check would go here
// const user = await getServerSideAuth(Astro);
// if (user) {
//   return Astro.redirect("/dashboard");
// }

// If token is provided, validate it server-side
// const tokenValidation = token ? await validateResetToken(token) : null;
// if (token && !tokenValidation?.isValid) {
//   // Handle invalid/expired token
// }
---

<Layout title={title} showAuth={false}>
  <div
    class="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800 py-12 px-4 sm:px-6 lg:px-8"
  >
    <div class="w-full max-w-md space-y-8">
      <!-- Header -->
      <div class="text-center">
        <a href="/" class="inline-flex items-center space-x-2 hover:opacity-80 transition-opacity mb-8">
          <div class="h-10 w-10 bg-primary rounded-lg flex items-center justify-center">
            <span class="text-primary-foreground font-bold">FC</span>
          </div>
          <span class="font-bold text-2xl">FishCards</span>
        </a>
      </div>

      {/* Form - conditionally render based on whether we have a token */}
      {isResetFlow ? <PasswordResetForm token={token as string} client:load /> : <ForgotPasswordForm client:load />}

      <!-- Help Section -->
      <div class="bg-card border border-border rounded-lg p-4 space-y-3">
        <h3 class="font-semibold text-sm text-foreground">
          {isResetFlow ? "Problemy z resetowaniem?" : "Potrzebujesz pomocy?"}
        </h3>
        <div class="text-xs text-muted-foreground space-y-2">
          {
            isResetFlow ? (
              <>
                <p>• Link resetowania jest ważny przez 24 godziny</p>
                <p>• Sprawdź czy adres URL jest kompletny</p>
                <p>• Link można użyć tylko raz</p>
              </>
            ) : (
              <>
                <p>• Sprawdź folder spam jeśli nie widzisz wiadomości</p>
                <p>• Link resetowania będzie ważny przez 24 godziny</p>
                <p>• Możesz poprosić o nowy link jeśli poprzedni wygasł</p>
              </>
            )
          }
        </div>
      </div>

      <!-- Security Notice -->
      {
        isResetFlow && (
          <div class="bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
            <div class="flex items-start">
              <svg
                class="w-5 h-5 text-blue-600 dark:text-blue-400 mt-0.5 mr-2 flex-shrink-0"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 15v2m-6 0h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                />
              </svg>
              <div>
                <h4 class="font-medium text-blue-900 dark:text-blue-100 text-sm">Informacja o bezpieczeństwie</h4>
                <p class="text-blue-800 dark:text-blue-200 text-xs mt-1">
                  Po zmianie hasła zostaniesz automatycznie zalogowany. Wszystkie inne sesje zostaną zakończone.
                </p>
              </div>
            </div>
          </div>
        )
      }

      <!-- Additional Links -->
      <div class="text-center space-y-4">
        <div class="text-sm text-muted-foreground space-y-2">
          <div>
            <a href="/auth/login" class="hover:text-primary transition-colors"> ← Powrót do logowania </a>
          </div>
          {
            !isResetFlow && (
              <div>
                <a href="/auth/register" class="hover:text-primary transition-colors">
                  Nie masz konta? Zarejestruj się
                </a>
              </div>
            )
          }
        </div>

        <!-- Contact Support -->
        <div class="border-t border-border pt-4">
          <p class="text-xs text-muted-foreground mb-2">Nadal masz problemy?</p>
          <a href="mailto:support@fishcards.app" class="text-sm text-primary hover:text-primary/80 transition-colors">
            Skontaktuj się z supportem
          </a>
        </div>
      </div>
    </div>
  </div>
</Layout>

<style>
  /* Custom styles for auth pages */
  body {
    background: linear-gradient(135deg, hsl(var(--muted)) 0%, hsl(var(--muted-foreground) / 0.05) 100%);
  }

  /* Subtle pulse animation for security notice */
  .security-notice {
    animation: subtlePulse 3s ease-in-out infinite;
  }

  @keyframes subtlePulse {
    0%,
    100% {
      background-opacity: 1;
    }
    50% {
      background-opacity: 0.8;
    }
  }
</style>

<!-- Client-side enhancements -->
<script>
  /* eslint-disable prettier/prettier */
  // Focus management for accessibility
  document.addEventListener("DOMContentLoaded", () => {
    const firstInput = document.querySelector("input");
    if (firstInput instanceof HTMLElement) {
      firstInput.focus();
    }
  });

  // Handle URL token validation on client side (additional security)
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get("token");

  if (token) {
    // Basic token format validation (more detailed validation on server)
    if (token.length < 10 || !/^[a-zA-Z0-9_-]+$/.test(token)) {
      // Invalid token format - could show user-friendly error message
    }

    // TODO: Add token expiry warning if close to expiration
    // TODO: Add analytics for reset link usage
  }

  // Handle successful password reset
  window.addEventListener("passwordResetSuccess", () => {
    // TODO: Add analytics tracking
    // TODO: Clear any stored auth tokens
  });

  // Auto-submit form if coming from email client with pre-filled data
  // This could be useful for mobile email clients
  const autoSubmit = urlParams.get("auto");
  if (autoSubmit && token) {
    // Add slight delay to ensure form is loaded
    setTimeout(() => {
      const form = document.querySelector("form");
      if (form) {
        const passwordInput = form.querySelector('input[type="password"]');
        if (passwordInput instanceof HTMLElement) {
          passwordInput.focus();
        }
      }
    }, 100);
  }
</script>

<!-- TODO: Add structured data for password reset page -->
<!-- TODO: Add proper meta tags for email preview -->
<!-- TODO: Add CSRF protection when backend is implemented -->
<!-- TODO: Add password reset analytics and conversion tracking -->
