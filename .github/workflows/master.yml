name: Master Branch CI

on:
  push:
    branches: [main, master]

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Restore bun cache
        uses: actions/cache@v5
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Lint
        run: bun run lint

  unit-test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [lint]
    environment: fishcards_production
    env:
      PUBLIC_ENV_NAME: ${{ secrets.PUBLIC_ENV_NAME }}
      PUBLIC_SUPABASE_URL: ${{ secrets.PUBLIC_SUPABASE_URL }}
      PUBLIC_SUPABASE_KEY: ${{ secrets.PUBLIC_SUPABASE_KEY }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      PUBLIC_MOCK_AI_GENERATION: ${{ secrets.PUBLIC_MOCK_AI_GENERATION }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Restore bun cache
        uses: actions/cache@v5
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run unit tests with coverage
        run: bun run test:coverage

      - name: Upload unit coverage
        uses: actions/upload-artifact@v6
        with:
          name: unit-coverage
          path: coverage/
          retention-days: 7

  deploy:
    name: Deploy to Cloudflare
    runs-on: ubuntu-latest
    needs: [lint, unit-test]
    environment: fishcards_production
    env:
      PUBLIC_ENV_NAME: prod
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Restore bun cache
        uses: actions/cache@v5
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build
        run: bun run build

      - name: Prepare Cloudflare public assets
        run: bun run prepare:cf-assets

      - name: Build Wrangler public vars from .env.production
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f ".env.production" ]; then
            echo ".env.production file not found" >&2
            exit 1
          fi

          args=""
          while IFS='=' read -r key value || [ -n "$key" ]; do
            # Skip empty lines and comments
            if [ -z "${key// }" ] || [[ "$key" =~ ^[[:space:]]*# ]]; then
              continue
            fi

            # Keep only non-secret/public vars
            if [[ "$key" == PUBLIC_* ]]; then
              args="$args --var ${key}:${value}"
            fi
          done < .env.production

          if [ -z "$args" ]; then
            echo "No PUBLIC_* variables found in .env.production" >&2
            exit 1
          fi

          echo "WRANGLER_DEPLOY_PUBLIC_VARS=${args# }" >> "$GITHUB_ENV"

      - name: Deploy to Cloudflare
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy ${{ env.WRANGLER_DEPLOY_PUBLIC_VARS }}
